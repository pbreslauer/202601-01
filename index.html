<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>49 Bus Tracker</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { text-align: center; width: 100%; }
        .route-label { font-size: 1.2rem; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        .eta-number { font-size: 10rem; font-weight: 900; color: #00FF41; line-height: 0.9; margin: 10px 0; }
        .unit { font-size: 1.5rem; color: #00FF41; font-weight: bold; }
        .footer { margin-top: 30px; font-size: 0.8rem; color: #333; }
        #status-msg { color: #888; font-style: italic; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container" onclick="updateTracker()">
        <div class="route-label">49 Southbound</div>
        <div id="stop-display" style="color:#444; font-size:0.9rem;">21st & Wallace</div>
        
        <div id="eta-container">
            <div class="eta-number" id="eta">--</div>
            <div class="unit" id="unit-label">MINUTES</div>
        </div>

        <div id="status-msg">Connecting to SEPTA...</div>
        <div class="footer">Tap screen to refresh â€¢ <span id="last-update">--</span></div>
    </div>

    <script>
        const STOP_ID = '21102';
        const ROUTE_ID = '49';

        async function updateTracker() {
            const etaDisp = document.getElementById('eta');
            const statusDisp = document.getElementById('status-msg');
            const timeDisp = document.getElementById('last-update');

            try {
                // Using a reliable proxy to bypass CORS
                const url = `https://www3.septa.org/api/Arrivals/index.php?stop_id=${STOP_ID}&results=3`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                // Get the arrivals list (the key is the stop name)
                const stopName = Object.keys(data)[0];
                const arrivals = data[stopName];

                // If 'arrivals' is a string, it means "No service" or "No buses found"
                if (!Array.isArray(arrivals)) {
                    etaDisp.innerText = "--";
                    statusDisp.innerText = "No buses currently detected";
                    return;
                }

                // Find the first 49 bus (Arrivals API already sorts by time)
                const nextBus = arrivals.find(bus => bus.route === ROUTE_ID);

                if (nextBus) {
                    etaDisp.innerText = nextBus.arrival_at;
                    statusDisp.innerText = "Next bus to 29th-Snyder";
                    etaDisp.style.color = "#00FF41";
                } else {
                    etaDisp.innerText = "OFF";
                    statusDisp.innerText = "49 not in next 3 arrivals";
                    etaDisp.style.color = "#ff4444";
                }
                
                timeDisp.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            } catch (err) {
                statusDisp.innerText = "Connection Lost";
                console.error(err);
            }
        }

        // Run immediately and then every 30 seconds
        updateTracker();
        setInterval(updateTracker, 30000);
    </script>
</body>
</html>
